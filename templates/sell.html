{% extends 'base.html' %}

{% block content %}
<div class="container">
  <h3 class="mb-4">Sell Product</h3>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ category }}">{{ message }}</div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <form method="POST">
    <div class="mb-3">
      <label for="productSelect" class="form-label">Select Product</label>
      <select name="product_id" id="productSelect" class="form-select" onchange="updateSizes(this)" required>
        <option value="" disabled selected>-- Choose a product --</option>
        {% for product in products %}
          <option 
            value="{{ product.id }}" 
            data-sizes="{{ ','.join([sq.size for sq in product.sizes]) }}" 
            data-image="{{ product.image_url }}"
          >
            Product #{{ product.id }} â€” ${{ "%.2f"|format(product.selling_price) }}
          </option>
        {% endfor %}
      </select>
    </div>

    <div class="mb-3">
      <label for="sizeDropdown" class="form-label">Select Size</label>
      <select name="size" id="sizeDropdown" class="form-select" required>
        <option value="">-- Select a size --</option>
      </select>
    </div>

    <div class="mb-3">
      <label for="quantity" class="form-label">Quantity</label>
      <input type="number" class="form-control" name="quantity" id="quantity" min="1" required>
    </div>

    <div class="mb-3">
      <img id="productImage" src="" alt="Selected Product Image" class="img-fluid rounded" style="max-height: 250px; display: none;">
    </div>

    <button type="submit" class="btn btn-primary">Sell</button>
  </form>
</div>

<!-- Scripts -->
<script>
  // Update size dropdown based on selected product
  function updateSizes(selectElement) {
    const selectedOption = selectElement.options[selectElement.selectedIndex];
    const sizeDropdown = document.getElementById('sizeDropdown');
    sizeDropdown.innerHTML = '<option value="">-- Select a size --</option>';

    if (selectedOption && selectedOption.dataset.sizes) {
      const sizes = selectedOption.dataset.sizes.split(',');
      for (const size of sizes) {
        const option = document.createElement('option');
        option.value = size;
        option.text = size;
        sizeDropdown.appendChild(option);
      }
    }
  }

  // Update product image on selection
  document.getElementById('productSelect').addEventListener('change', function () {
    const selectedOption = this.options[this.selectedIndex];
    const imageUrl = selectedOption.getAttribute('data-image');
    const imageEl = document.getElementById('productImage');

    if (imageUrl) {
      imageEl.src = imageUrl;
      imageEl.style.display = 'block';
    } else {
      imageEl.style.display = 'none';
    }
  });
</script>
{% endblock %}
