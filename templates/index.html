{% extends 'base.html' %}
{% block content %}
<div class="mb-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2>Welcome, {{ current_user.username }}! 
      {% if current_user.is_admin() %}
        <span class="badge bg-primary">Admin</span>
      {% else %}
        <span class="badge bg-secondary">Employee</span>
      {% endif %}
    </h2>
    <a href="{{ url_for('logout') }}" class="btn btn-outline-danger">Logout</a>
  </div>
  
  <!-- Navigation buttons based on role -->
  <div class="row g-2 mb-3">
    <div class="col-md-3">
      <a href="{{ url_for('search_by_size') }}" class="btn btn-info w-100">üîç Search by Size</a>
    </div>
    <div class="col-md-3">
      <a href="{{ url_for('sell_product') }}" class="btn btn-warning w-100">üí∞ Sell Product</a>
    </div>
    
    {% if current_user.is_admin() %}
    <!-- Admin-only buttons -->
    <div class="col-md-2">
      <a href="{{ url_for('add_product') }}" class="btn btn-success w-100">‚ûï Add Product</a>
    </div>
    <div class="col-md-2">
      <a href="{{ url_for('report') }}" class="btn btn-primary w-100">üìä Reports</a>
    </div>
    <div class="col-md-2">
      <a href="{{ url_for('manage_users') }}" class="btn btn-secondary w-100">üë• Users</a>
    </div>
    {% endif %}
  </div>

  <!-- Filter controls -->
  <div class="card mb-4">
    <div class="card-body">
      <h5 class="card-title">Filter Products</h5>
      <form method="GET" class="row g-3 align-items-end">
        <div class="col-md-4">
          <label for="season" class="form-label">Season</label>
          <select name="season" id="season" class="form-select">
            <option value="All" {% if season_filter == "All" %}selected{% endif %}>All Seasons</option>
            <option value="Summer" {% if season_filter == "Summer" %}selected{% endif %}>Summer</option>
            <option value="Winter" {% if season_filter == "Winter" %}selected{% endif %}>Winter</option>
            <option value="Spring/Autumn" {% if season_filter == "Spring/Autumn" %}selected{% endif %}>Spring/Autumn</option>
          </select>
        </div>
        <div class="col-md-4">
          <label for="gender" class="form-label">Gender</label>
          <select name="gender" id="gender" class="form-select">
            <option value="All" {% if gender_filter == "All" %}selected{% endif %}>All Genders</option>
            <option value="Boys" {% if gender_filter == "Boys" %}selected{% endif %}>Boys</option>
            <option value="Girls" {% if gender_filter == "Girls" %}selected{% endif %}>Girls</option>
          </select>
        </div>
        <div class="col-md-4">
          <button type="submit" class="btn btn-primary me-2">Apply Filters</button>
          <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">Clear</a>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Product cards -->
<div class="row row-cols-1 row-cols-md-2 g-4">
    {% for product in products %}
    <div class="col">
      <div class="card h-100">
        <div class="position-relative">
          <img src="{{ product.image_url }}" class="img-fluid mb-2" alt="Product Image">
          <!-- Category badges -->
          <div class="position-absolute top-0 start-0 m-2">
            <span class="badge bg-{% if product.season == 'Summer' %}warning{% elif product.season == 'Winter' %}info{% else %}success{% endif %} me-1">
              {{ product.season }}
            </span>
            <span class="badge bg-{% if product.gender == 'Boys' %}primary{% else %}danger{% endif %}">
              {{ product.gender }}
            </span>
          </div>
        </div>

        <div class="card-body">
          <h5 class="card-title"><a href="{{ product.style_url }}" target="_blank">View Style</a></h5>
          <p><strong>Price:</strong> {{ product.selling_price|int }} IQD</p>
          <p><strong>Category:</strong> {{ product.season }} - {{ product.gender }}</p>
          
          <!-- Stock information -->
          <p><strong>Stock:</strong></p>
          <ul>
            {% for sq in product.sizes %}
              <li {% if sq.quantity <= 1 %} style="color: red; font-weight: bold;" {% endif %}>
                Size {{ sq.size }}: {{ sq.quantity }} sets available
                {% if sq.quantity <= 1 %} ‚ö†Ô∏è Low Stock {% endif %}
              </li>
            {% endfor %}
          </ul>
          
          {% if current_user.is_admin() %}
          <!-- Admin-only buttons -->
          <div class="mt-3">
            <a href="{{ url_for('edit_product', product_id=product.id) }}" class="btn btn-sm btn-warning me-2">Edit</a>
            <form action="{{ url_for('delete_product', product_id=product.id) }}" method="POST" style="display:inline-block;" onsubmit="return confirm('Are you sure?');">
              <button class="btn btn-sm btn-danger">Delete</button>
            </form>
          </div>
          
          <!-- Admin-only cost information -->
          <div class="mt-3 p-2 bg-light rounded">
            <small class="text-muted">
              <strong>Cost Info:</strong><br>
              Unit Cost: {{ '%.0f'|format(product.unit_cost) }} IQD<br>
              Total Cost: {{ '%.0f'|format(product.total_cost) }} IQD<br>
              Shipping: {{ '%.0f'|format(product.shipping_cost) }} IQD
            </small>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
    {% endfor %}
</div>

{% if current_user.is_admin() and low_stock_items %}
<!-- Low stock alert (admin only) -->
<div class="alert alert-warning mt-4">
  <h5 class="alert-heading">üö® Low Stock Alert</h5>
  <ul class="mb-0">
    {% for item in low_stock_items %}
    <li>Product #{{ item.product.id }} ({{ item.product.season }} - {{ item.product.gender }}) - Size {{ item.size }}: {{ item.quantity }} left</li>
    {% endfor %}
  </ul>
</div>
{% endif %}

{% endblock %}